# デモシナリオ詳細

## 概要
このドキュメントは、「Wrong is the new Down」デモアプリケーションの実施シナリオを詳細に説明します。

---

## シナリオ1: 問題版の実演（Before）

### 目的
カスタムError HandlerがHTTP 302を返すことで、Instanaが誤って「正常」と判断する問題を実演します。

### 手順

#### 1. 環境準備
```bash
cd ~/demo/wrong-is-new-down-demo/scripts
./switch_to_problem.sh
```

**確認ポイント:**
- `.env`ファイルで`USE_CUSTOM_ERROR_HANDLER=True`になっていること
- コンソールに警告メッセージが表示されること

#### 2. アプリケーション起動
```bash
cd ../demo_app
source ../venv/bin/activate
python manage.py runserver 0.0.0.0:8000
```

**確認ポイント:**
- サーバーが正常に起動すること
- ログに「Custom Error Handler is ENABLED」と表示されること

#### 3. データベース接続を壊す
```bash
# 別のターミナルで実行
cd ~/demo/wrong-is-new-down-demo/scripts
./break_database.sh
```

**確認ポイント:**
- `.env`ファイルで`DATABASE_NAME=wrong_demo_app`になっていること
- 元のデータベース名がバックアップされていること

#### 4. アプリケーション再起動
```bash
# アプリケーションのターミナルで Ctrl+C で停止
python manage.py runserver 0.0.0.0:8000
```

#### 5. ブラウザでログインを試みる
```
http://<EC2-PUBLIC-IP>:8000/login/
```

**操作:**
1. ユーザー名: `testuser`
2. パスワード: `testpass`
3. 「ログイン」ボタンをクリック

**期待される結果:**
- ブラウザがログイン画面にリダイレクトされる
- エラーメッセージは表示されない（ユーザーからは正常に見える）

#### 6. サーバーログの確認
```bash
# アプリケーションのターミナルで確認
```

**確認ポイント:**
- `ERROR`ログが記録されている
- `OperationalError: database "wrong_demo_app" does not exist`
- `Returning HTTP 302 redirect to /login/ (This is the problem!)`

#### 7. Instanaダッシュボードで確認

**手順:**
1. Instanaダッシュボードにログイン
2. Applications → [アプリケーション名] → Calls
3. `POST /login/submit/` を検索

**確認ポイント:**
- **HTTPステータスコード**: `302 - Found` （🔄 青信号）
- **トレース判定**: 正常（エラーとして検知されていない）
- **ログセクション**: `ERROR`が記録されている
- **アラート**: 発火していない（これが問題！）

**デモのハイライト:**
> 「見てください。Instanaは302を受け取り、『青信号』つまり正常なリダイレクトと判断しています。
> しかし、ログセクションを見ると、データベースエラーが発生していることが分かります。
> システムは動いていますが、結果は間違っています。
> これが『Wrong is the new Down』現象です。」

---

## シナリオ2: 修正版の実演（After）

### 目的
Django標準エラーハンドリングに変更することで、Instanaが正しくエラーを検知することを実演します。

### 手順

#### 1. 修正版への切り替え
```bash
cd ~/demo/wrong-is-new-down-demo/scripts
./switch_to_fixed.sh
```

**確認ポイント:**
- `.env`ファイルで`USE_CUSTOM_ERROR_HANDLER=False`になっていること

#### 2. アプリケーション再起動
```bash
cd ../demo_app
# Ctrl+C で停止
python manage.py runserver 0.0.0.0:8000
```

**確認ポイント:**
- ログに「Custom Error Handler is DISABLED」と表示されること

#### 3. ブラウザで再度ログインを試みる
```
http://<EC2-PUBLIC-IP>:8000/login/
```

**操作:**
1. ユーザー名: `testuser`
2. パスワード: `testpass`
3. 「ログイン」ボタンをクリック

**期待される結果:**
- ブラウザに「500 Internal Server Error」が表示される
- システムがエラーを正直に報告する

#### 4. サーバーログの確認

**確認ポイント:**
- `ERROR`ログが記録されている
- `OperationalError: database "wrong_demo_app" does not exist`
- カスタムError Handlerの介入がない

#### 5. Instanaダッシュボードで再確認

**手順:**
1. Instanaダッシュボードにログイン
2. Applications → [アプリケーション名] → Calls
3. `POST /login/submit/` を検索（最新のトレース）

**確認ポイント:**
- **HTTPステータスコード**: `500 - Internal Server Error` （❌ 赤信号）
- **トレース判定**: エラー（正しく検知されている）
- **ログセクション**: `ERROR`が記録されている
- **アラート**: 正しく発火している

**デモのハイライト:**
> 「修正後はHTTP 500を返しています。Instanaはこれを『赤信号』つまりエラーとして正しく検知し、
> アラートが発火しています。これが本来あるべき動作です。
> たった1-2日の修正で、見逃されていた障害が可視化されるようになりました。」

---

## シナリオ3: 正常動作の確認

### 目的
データベース接続を修復して、システムが正常に動作することを確認します。

### 手順

#### 1. データベース接続の修復
```bash
cd ~/demo/wrong-is-new-down-demo/scripts
./fix_database.sh
```

**確認ポイント:**
- `.env`ファイルで`DATABASE_NAME=demo_app`に戻っていること

#### 2. アプリケーション再起動
```bash
cd ../demo_app
# Ctrl+C で停止
python manage.py runserver 0.0.0.0:8000
```

#### 3. データベースマイグレーション（初回のみ）
```bash
python manage.py migrate
```

#### 4. テストユーザーの作成（オプション）
```bash
python manage.py createsuperuser
```

#### 5. ブラウザでログイン
```
http://<EC2-PUBLIC-IP>:8000/login/
```

**操作:**
1. ユーザー名: 作成したユーザー名
2. パスワード: 設定したパスワード
3. 「ログイン」ボタンをクリック

**期待される結果:**
- ブラウザに「✅ Login successful」と表示される
- HTTPステータス: 200
- エラーログなし

#### 6. Instanaダッシュボードで確認

**確認ポイント:**
- **HTTPステータスコード**: `200 - OK` （🟢 緑信号）
- **トレース判定**: 成功
- **レスポンスタイム**: 正常範囲内
- **エラーなし**

---

## トークポイント

### シナリオ1の説明（問題版）
```
「まず、問題版をお見せします。
ここでは、カスタムError Handlerが有効化されており、
エラーが発生してもHTTP 302を返すようになっています。

データベース接続を意図的に壊して、ログインを試みます。
（操作）

見てください。ユーザーからは何も異常が分かりません。
ログイン画面に戻されただけです。

しかし、サーバーログを見ると、データベースエラーが発生しています。
『database "wrong_demo_app" does not exist』

そして、Instanaダッシュボードを確認すると...
HTTPステータスは302。つまり『青信号』です。
Instanaは『正常なリダイレクト』と判断し、アラートは発火していません。

これが『Wrong is the new Down』現象です。
システムは動いていますが、結果は間違っています。」
```

### シナリオ2の説明（修正版）
```
「では、修正版を見てみましょう。
カスタムError Handlerを無効化して、
Django標準のエラーハンドリングに戻します。

同じようにログインを試みます。
（操作）

今度は、ブラウザに『500 Internal Server Error』が表示されました。
システムが正直にエラーを報告しています。

Instanaダッシュボードを確認すると...
HTTPステータスは500。つまり『赤信号』です。
Instanaは正しくエラーを検知し、アラートが発火しています。

この修正は1-2日で完了しました。
たったこれだけで、見逃されていた障害が可視化されるようになったのです。」
```

### シナリオ3の説明（正常動作）
```
「最後に、データベース接続を修復して、
システムが正常に動作することを確認しましょう。

（操作）

HTTP 200が返り、ログインが成功しました。
これが『緑信号』、つまり本来の正常動作です。

このデモを通じて、HTTPステータスコードの重要性と、
適切なエラーハンドリングの必要性をご理解いただけたと思います。」
```

---

## Q&A想定

### Q1: なぜHTTP 302を返すコードが書かれたのか？
**A:** 実際のケースでは、ユーザー体験を向上させるため、エラー画面ではなくログイン画面にリダイレクトする意図だったと考えられます。しかし、これが監視ツールの盲点となってしまいました。

### Q2: ログに ERROR が記録されているなら、それで検知できるのでは?
**A:** その通りです。しかし、多くの監視ツールはHTTPステータスコードを優先します。また、ログは量が多く、リアルタイムで全てを監視するのは困難です。HTTPステータスコードによる自動検知が重要です。

### Q3: 他にも同様の問題が発生するケースはあるか？
**A:** はい。例えば：
- HTTP 200を返しながら、レスポンスボディにエラー情報を含める
- HTTP 204（No Content）を返しながら、実際にはデータ取得に失敗している
- タイムアウトエラーを HTTP 408 ではなく HTTP 200 で返す

これらすべてが「Wrong is the new Down」の一種です。

### Q4: Instanaだけの問題なのか？
**A:** いいえ。これはHTTPステータスコードに依存する全ての監視ツールに共通の課題です。適切なHTTPステータスコードを返すことは、アプリケーション開発者の責任です。

---

## デモの成功ポイント

1. **準備確認**: 事前に全ての手順をテストしておく
2. **タイミング**: 各操作の間に適切な間を取り、観客が理解する時間を与える
3. **視覚化**: ブラウザ、ログ、Instanaの3つを同時に見せることで、問題を立体的に理解してもらう
4. **比較**: Before/Afterを明確に対比させる
5. **ストーリー**: 技術的な説明だけでなく、「なぜこれが重要か」を伝える

---

## トラブルシューティング（デモ中）

### Instanaでトレースが見つからない
→ 「実際の環境ではトレースの伝播に数秒かかることがあります。少々お待ちください。」

### アプリケーションが起動しない
→ 予備のEC2インスタンスを用意しておく、またはローカルでデモする

### ブラウザが接続できない
→ セキュリティグループの設定を再確認、または ngrok などのトンネリングツールを使用

---

このデモシナリオを通じて、「Wrong is the new Down」という新しい概念を、
技術者だけでなく、マネージャーやビジネス関係者にも理解してもらえます。
